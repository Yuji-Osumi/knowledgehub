# 認証システム詳細設計書

**バージョン:** 2.0
**作成日:** 2026-02-01
**最終更新日:** 2026-02-01
**ステータス:** ✅ 実装完了（MVP）

---

## 目次

1. [概要](#概要)
2. [CORS 設定](#cors-設定)
3. [エラーハンドリング](#エラーハンドリング)
4. [エンドポイント認証定義](#エンドポイント認証定義)
5. [認証フロー実装](#認証フロー実装)
6. [セキュリティ設計](#セキュリティ設計)
7. [実装コード例](#実装コード例)
8. [設計判断とトレードオフ](#設計判断とトレードオフ)
9. [テスト結果](#テスト結果)
10. [将来の拡張性](#将来の拡張性)
11. [参考資料](#参考資料)

---

## 概要

### 認証方式

KnowledgeHub MVP では **Session + Cookie + Redis** による認証を採用。

| 要素           | 実装                            | 目的                 |
| -------------- | ------------------------------- | -------------------- |
| **Session ID** | UUID v4 (32文字 hex)            | セッション識別子     |
| **Cookie**     | HttpOnly, Secure, SameSite=lax  | XSS/CSRF 対策        |
| **Redis**      | セッションデータ保存（TTL 24h） | 高速セッション検証   |
| **PostgreSQL** | ユーザー情報永続化              | アカウントデータ管理 |

### 実装済み機能一覧

| 機能                   | ファイル                            | 説明                         |
| ---------------------- | ----------------------------------- | ---------------------------- |
| セッション管理         | `backend/app/core/redis_manager.py` | Redis CRUD 操作              |
| 認証依存関数           | `backend/app/core/dependencies.py`  | `get_current_user()`         |
| パスワードセキュリティ | `backend/app/core/security.py`      | bcrypt ハッシュ化・検証      |
| 認証 API               | `backend/app/api/auth.py`           | signup/login/logout/me       |
| 記事 API               | `backend/app/api/articles.py`       | CRUD + 認証 + 所有者チェック |
| 例外ハンドリング       | `backend/app/core/exceptions.py`    | AppException 系統            |
| エラーハンドラ         | `backend/app/main.py`               | 統一エラーレスポンス         |

---

## CORS 設定

### ミドルウェア設定

**ファイル:** `backend/app/main.py`

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_allow_origins,
    allow_credentials=True,  # Cookie 送信を許可
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 環境別 Origins

| 環境      | Origins                                          | Secure Cookie |
| --------- | ------------------------------------------------ | ------------- |
| **local** | `http://localhost:5173`, `http://localhost:3000` | false         |
| **dev**   | `https://dev.example.com`                        | true          |
| **prod**  | `https://example.com`                            | true          |

**設定ファイル:** `backend/app/core/config.py`

```python
class LocalSettings(AppSettings):
    cors_allow_origins: List[str] = ["http://localhost:5173", "http://localhost:3000"]
    SECURE_COOKIE: bool = False

class ProdSettings(AppSettings):
    cors_allow_origins: List[str] = ["https://example.com"]
    SECURE_COOKIE: bool = True
```

### 動作確認

```bash
$ curl -i -X POST "http://localhost:8000/api/auth/login" \
  -H "Origin: http://localhost:5173" \
  -d '{"email": "test@example.com", "password": "Test1234"}'

HTTP/1.1 200 OK
access-control-allow-credentials: true
access-control-allow-origin: http://localhost:5173
set-cookie: session_id=...; HttpOnly; SameSite=lax
```

---

## エラーハンドリング

### ステータスコード統一ルール

| ステータス                    | 用途               | 判断基準                                      |
| ----------------------------- | ------------------ | --------------------------------------------- |
| **200 OK**                    | 成功               | リソース取得成功                              |
| **201 Created**               | リソース作成成功   | ユーザー登録、記事作成                        |
| **204 No Content**            | 成功（ボディなし） | ログアウト、削除                              |
| **400 Bad Request**           | 入力不備           | バリデーション失敗、形式エラー                |
| **401 Unauthorized**          | 認証不備           | Cookie 未設定、セッション無効、認証情報不一致 |
| **404 Not Found**             | リソース不在       | 記事未検出、所有者不一致（情報隠蔽）          |
| **500 Internal Server Error** | サーバーエラー     | 予期しない例外                                |

### 400/401 区分の詳細

#### ✅ 400 Bad Request（入力不備）

**適用ケース:**
- Pydantic バリデーション失敗（無効なメール、文字数不足）
- パスワード強度不足
- 必須フィールド欠落
- JSON 形式エラー

**実装:** `RequestValidationError` ハンドラ

```python
@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    return JSONResponse(
        status_code=400,
        content={
            "error": {
                "code": "VALIDATION_ERROR",
                "message": "Validation failed",
                "details": exc.errors(),
            }
        },
    )
```

**レスポンス例:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": [
      {
        "type": "value_error",
        "loc": ["body", "email"],
        "msg": "value is not a valid email address",
        "input": "invalid"
      }
    ]
  }
}
```

#### ✅ 401 Unauthorized（認証不備）

**適用ケース:**
- Cookie の `session_id` が未設定
- セッションが無効・期限切れ
- ログイン認証情報の不一致
- ユーザーが DB に存在しない

**実装:** `UnauthorizedError` 例外

```python
class UnauthorizedError(AppException):
    def __init__(self, message: str = "Authentication required", details: Optional[Dict[str, Any]] = None):
        super().__init__(
            message=message,
            error_code="UNAUTHORIZED",
            status_code=401,
            details=details
        )
```

**レスポンス例:**
```json
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Authentication required",
    "details": null
  }
}
```

### 統一エラーレスポンス形式

全てのエラーは以下の形式で返却：

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable message",
    "details": null | { ... }
  }
}
```

---

## エンドポイント認証定義

### Public Endpoints（認証不要）

| メソッド | エンドポイント | 説明         | ステータスコード |
| -------- | -------------- | ------------ | ---------------- |
| POST     | `/auth/signup` | ユーザー登録 | 201 Created      |
| POST     | `/auth/login`  | ログイン     | 200 OK           |

### Private Endpoints（認証必須）

| メソッド | エンドポイント          | 説明                   | 所有者チェック         |
| -------- | ----------------------- | ---------------------- | ---------------------- |
| POST     | `/auth/logout`          | ログアウト             | -                      |
| GET      | `/auth/me`              | 現在のユーザー情報取得 | -                      |
| GET      | `/articles`             | 記事一覧取得           | 不要（自分の記事のみ） |
| POST     | `/articles`             | 記事作成               | -                      |
| GET      | `/articles/{public_id}` | 記事詳細取得           | ✅ 必須（404 統一）     |
| PUT      | `/articles/{public_id}` | 記事更新               | ✅ 必須（404 統一）     |
| DELETE   | `/articles/{public_id}` | 記事削除（論理削除）   | ✅ 必須（404 統一）     |

### 今後実装予定

- タグ API: `GET /tags`, `POST /tags`, `PUT /tags/{id}`, `DELETE /tags/{id}`
- フォルダ API: `GET /folders`, `POST /folders`, `PUT /folders/{id}`, `DELETE /folders/{id}`
- 監査ログ API: `GET /logs`（管理者権限必須）

---

## 認証フロー実装

### 1. `get_current_user()` 依存関数

**ファイル:** `backend/app/core/dependencies.py`

**目的:** FastAPI の依存性注入で認証を自動化

#### 処理フロー

```
1. Request から Cookie を抽出
   ↓
2. session_id の有無確認
   → 無い場合: 401 Unauthorized
   ↓
3. Redis でセッション有効性確認
   → 無効/期限切れ: 401 Unauthorized
   ↓
4. セッションから user_id を取得
   ↓
5. DB で User オブジェクトを取得
   → 未検出: 401 Unauthorized
   ↓
6. User オブジェクトを返却
```

#### 実装コード

```python
from uuid import UUID
from fastapi import Depends, Request
from sqlalchemy.orm import Session
from app.core.exceptions import UnauthorizedError
from app.core.redis_manager import redis_manager
from app.db.models.user import User
from app.db.session import get_db

async def get_current_user(
    request: Request,
    db: Session = Depends(get_db),
) -> User:
    """Cookie からセッションを検証し、認証ユーザーを返す"""

    # 1. Cookie から session_id を抽出
    session_id = request.cookies.get("session_id")
    if not session_id:
        raise UnauthorizedError()

    # 2. Redis でセッション有効性確認
    if not redis_manager.is_session_valid(session_id):
        raise UnauthorizedError()

    # 3. セッションから user_id を取得
    session_data = redis_manager.get_session(session_id)
    if not session_data:
        raise UnauthorizedError()

    user_id = session_data.get("user_id")
    if not user_id:
        raise UnauthorizedError()

    # 4. DB からユーザー情報を取得
    user = db.query(User).filter(User.public_id == UUID(user_id)).first()
    if not user:
        raise UnauthorizedError()

    return user
```

### 2. Cookie セッション設定

#### Cookie パラメータ

| 項目         | 値                    | 目的                                            |
| ------------ | --------------------- | ----------------------------------------------- |
| **key**      | `session_id`          | セッション識別子                                |
| **value**    | UUID v4 hex（32文字） | セッション ID                                   |
| **httponly** | `true`                | JavaScript からのアクセスを防止（XSS 対策）     |
| **secure**   | 環境依存              | HTTPS 通信時のみ送信（本番: true, 開発: false） |
| **samesite** | `lax`                 | CSRF 攻撃を軽減                                 |
| **max_age**  | `86400`               | 24時間有効                                      |
| **path**     | `/`                   | 全経路で有効                                    |

#### 実装例（Login 時）

```python
response = JSONResponse(content=user_response.model_dump())
response.set_cookie(
    key="session_id",
    value=session_id,
    httponly=True,
    secure=settings.SECURE_COOKIE,  # 環境依存
    samesite="lax",
    max_age=86400,  # 24時間
    path="/",
)
return response
```

### 3. Redis セッション管理

#### セッションデータ構造

```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "exp_timestamp": 1738396800
}
```

#### セッション操作

| 操作 | メソッド                             | 説明                           |
| ---- | ------------------------------------ | ------------------------------ |
| 作成 | `create_session(user_id, ttl_hours)` | Redis に保存（TTL 付き）       |
| 取得 | `get_session(session_id)`            | セッションデータを JSON で取得 |
| 検証 | `is_session_valid(session_id)`       | 存在確認 + 期限チェック        |
| 削除 | `delete_session(session_id)`         | ログアウト時に削除             |

---

## セキュリティ設計

### 1. 所有者チェック（404 統一）

#### 実装方針

記事の更新・削除時に、認証ユーザーの `user_id` がリソースの `user_id` と一致するか確認。
**不一致の場合は 404 Not Found を返却（403 Forbidden ではない）。**

#### 理由

| 理由               | 説明                                                                      |
| ------------------ | ------------------------------------------------------------------------- |
| **情報漏洩防止**   | 403 では「リソースは存在するが権限がない」と判明。404 で存在自体を隠蔽    |
| **一貫性**         | 削除済みリソース（`is_valid=False`）も 404 で返すため、存在状況が判別不可 |
| **ユーザビリティ** | クライアント側の処理が単純化（404 で統一）                                |

#### 実装コード

```python
def update_article(
    public_id: UUID,
    payload: ArticleUpdate,
    user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    # 1. リソース検索（is_valid=True のみ）
    article = db.query(Article).filter(
        Article.public_id == public_id,
        Article.is_valid == True,
    ).first()

    if not article:
        raise NotFoundError(f"Article with public_id {public_id} not found")

    # 2. 所有者チェック（不一致でも 404）
    if article.user_id != user.id:
        raise NotFoundError(f"Article with public_id {public_id} not found")

    # 3. 更新処理
    article.title = payload.title
    article.content = payload.content
    article.updated_by = user.id
    db.add(article)
    db.commit()
    db.refresh(article)

    return article
```

### 2. 論理削除対応（is_valid フィルタ）

#### 実装ルール

全ての SELECT クエリに **`is_valid == True` 条件** を付与：

```python
# ✅ 正しい実装
articles = db.query(Article).filter(
    Article.user_id == user.id,
    Article.is_valid == True,  # 必須
).all()

# ❌ 誤った実装（削除済みも表示される）
articles = db.query(Article).filter(
    Article.user_id == user.id,
).all()
```

#### 削除処理

```python
def delete_article(public_id: UUID, user: User, db: Session):
    article = db.query(Article).filter(
        Article.public_id == public_id,
        Article.user_id == user.id,
        Article.is_valid == True,
    ).first()

    if not article:
        raise NotFoundError(...)

    # 論理削除（物理削除しない）
    article.is_valid = False
    article.updated_by = user.id
    db.add(article)
    db.commit()
```

### 3. パスワードセキュリティ

#### ハッシュ化

- **アルゴリズム:** bcrypt
- **コスト係数:** 12
- **最大長:** 72 バイト（bcrypt 制限）

```python
import bcrypt

def hash_password(password: str) -> str:
    if len(password.encode("utf-8")) > 72:
        password = password[:72]

    salt = bcrypt.gensalt(rounds=12)
    hashed = bcrypt.hashpw(password.encode("utf-8"), salt)
    return hashed.decode("utf-8")
```

#### パスワード強度要件

- 最小 8 文字
- 大文字を最低 1 文字含む
- 小文字を最低 1 文字含む
- 数字を最低 1 文字含む

---

## 実装コード例

### 認証必須エンドポイント

```python
from fastapi import APIRouter, Depends
from app.core.dependencies import get_current_user
from app.db.models.user import User

router = APIRouter()

@router.get("/me")
async def get_me(user: User = Depends(get_current_user)):
    """認証が必須なエンドポイント"""
    return {
        "public_id": str(user.public_id),
        "email": user.email,
        "display_name": user.display_name,
    }
```

### 所有者チェック付き取得

```python
def get_article_by_id(
    public_id: UUID,
    user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """記事詳細取得（所有者チェック付き）"""
    article = db.query(Article).filter(
        Article.public_id == public_id,
        Article.user_id == user.id,  # 所有者チェック
        Article.is_valid == True,     # 論理削除フィルタ
    ).first()

    if not article:
        raise NotFoundError(f"Article with public_id {public_id} not found")

    return article
```

### エラーハンドリング例

```python
from app.core.exceptions import ValidationError, UnauthorizedError

# 入力検証エラー（400）
if not is_valid_format(email):
    raise ValidationError(message="Invalid email format")

# 認証エラー（401）
if not verify_password(password, user.password_hash):
    raise UnauthorizedError(message="Invalid email or password")
```

---

## 設計判断とトレードオフ

### 1. JWT vs Session 認証

**選択: Session + Cookie（MVP 採用）**

| 項目                 | Session       | JWT                        | 採用理由                   |
| -------------------- | ------------- | -------------------------- | -------------------------- |
| **実装複雑度**       | シンプル      | 複雑（署名・検証）         | ✅ MVP ではシンプルさを優先 |
| **セッション無効化** | 即座に可能    | 困難（Token Refresh 必要） | ✅ セキュリティ対応が重要   |
| **モバイル対応**     | Cookie に依存 | 対応容易                   | Phase 2 で検討             |
| **サーバー負荷**     | Redis 必須    | ステートレス               | Redis は他用途でも使用     |

**Phase 2 での検討:** モバイルアプリ化時に JWT への移行を評価。

### 2. 404 vs 403（所有者チェック）

**選択: 404 で統一**

| エラーコード | 返却内容    | メリット               | デメリット         |
| ------------ | ----------- | ---------------------- | ------------------ |
| **404**      | "Not found" | リソース存在情報を隠蔽 | デバッグが困難     |
| **403**      | "Forbidden" | 権限不足が明確         | リソース存在が露呈 |

**採用理由:**
- ✅ リソース ID の枚挙攻撃への耐性向上
- ✅ 所有者関係の情報漏洩防止
- ℹ️ ログには詳細を記録（開発時デバッグ可能）

### 3. 論理削除 vs 物理削除

**選択: 論理削除（is_valid フラグ）**

| 方式         | 実装             | メリット           | デメリット     |
| ------------ | ---------------- | ------------------ | -------------- |
| **論理削除** | `is_valid=False` | 復元可能、監査証跡 | ストレージ増加 |
| **物理削除** | `DELETE`         | ストレージ節約     | 復元不可       |

**適用範囲:**
- 論理削除: 記事、ユーザーアカウント
- 物理削除: セッション、一時データ

### 4. セッション TTL: 24時間

**選択: 24 時間（MVP）**

| 項目             | 24時間                | 8時間              | 判断               |
| ---------------- | --------------------- | ------------------ | ------------------ |
| **ユーザーUX**   | 再ログイン不要        | 頻繁な再ログイン   | ✅ MVP は UX 優先   |
| **セキュリティ** | Cookie 盗難リスク長い | リスク軽減         | Phase 2 で短縮検討 |
| **Redis 負荷**   | 少ない                | 多い（再生成頻繁） | ✅                  |

---

## テスト結果

### 認証フローテスト（11項目）

| No  | テスト内容             | 期待結果                     | 結果 |
| --- | ---------------------- | ---------------------------- | ---- |
| 1   | Signup 成功            | 201 Created + Cookie 設定    | ✅    |
| 2   | 重複メールで Signup    | 400 Bad Request              | ✅    |
| 3   | Login 成功             | 200 OK + Cookie 設定         | ✅    |
| 4   | 無効な認証情報で Login | 401 Unauthorized             | ✅    |
| 5   | Cookie なしで /auth/me | 401 Unauthorized             | ✅    |
| 6   | Cookie ありで /auth/me | 200 OK + ユーザー情報        | ✅    |
| 7   | Logout 成功            | 204 No Content + Cookie 削除 | ✅    |
| 8   | Logout 後に /auth/me   | 401 Unauthorized             | ✅    |
| 9   | 記事作成（認証あり）   | 201 Created                  | ✅    |
| 10  | 他人の記事を取得       | 404 Not Found                | ✅    |
| 11  | 削除済み記事を取得     | 404 Not Found                | ✅    |

### エラーハンドリングテスト（8項目）

| No  | テスト内容           | 期待結果                                           | 結果 |
| --- | -------------------- | -------------------------------------------------- | ---- |
| 1   | 無効なメールアドレス | 400 + VALIDATION_ERROR                             | ✅    |
| 2   | パスワード強度不足   | 400 + VALIDATION_ERROR                             | ✅    |
| 3   | 無効な認証情報       | 401 + UNAUTHORIZED                                 | ✅    |
| 4   | Cookie なし          | 401 + UNAUTHORIZED                                 | ✅    |
| 5   | CORS Origin 確認     | access-control-allow-credentials: true             | ✅    |
| 6   | CORS Origin 一致     | access-control-allow-origin: http://localhost:5173 | ✅    |
| 7   | Cookie HttpOnly 確認 | Set-Cookie: HttpOnly                               | ✅    |
| 8   | Cookie SameSite 確認 | Set-Cookie: SameSite=lax                           | ✅    |

---

## 将来の拡張性

### Phase 2 での検討事項

#### 1. JWT への移行

**タイミング:** モバイルアプリケーション対応時

**実装ステップ:**
1. JWT 署名・検証ロジック実装（`python-jose`）
2. Token Refresh エンドポイント追加（`/auth/refresh`）
3. Cookie と Authorization ヘッダの両対応
4. セッション方式との並行運用期間

#### 2. ロールベースアクセス制御（RBAC）

**用途:**
- ユーザー権限管理（admin / user / readonly）
- リソースレベルのアクセス制御
- 監査ログ閲覧権限

**実装:**
```python
class User(Base):
    role: str  # "admin", "user"

def get_current_admin(user: User = Depends(get_current_user)):
    if user.role != "admin":
        raise ForbiddenException()
    return user
```

#### 3. API キー方式

**用途:**
- 外部サービス連携
- Webhook 認証
- CI/CD パイプライン

#### 4. 多要素認証（MFA）

**実装候補:**
- TOTP（Time-based One-Time Password）
- SMS 認証
- バックアップコード

---

## 参考資料

### プロジェクト内ドキュメント

- [認証・認可方針](../../01_要件定義/0.9.1_認証・認可方針.md) - MVP 認証仕様
- [例外処理ポリシー](../../03_実装方針/05_例外処理ポリシー（Backend）.md) - エラーレスポンス定義
- [セキュリティ方針](../../03_実装方針/06_セキュリティ方針（MVP）.md) - XSS、CSRF 対策

### 外部リソース

- [FastAPI Dependencies](https://fastapi.tiangolo.com/tutorial/dependencies/) - 依存性注入システム
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html) - 認証ベストプラクティス
- [OWASP Session Management](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html) - セッション管理
- [Redis Documentation](https://redis.io/docs/) - Redis 公式ドキュメント

---

**文書版管理**

| バージョン | 日時       | 更新内容                                     |
| ---------- | ---------- | -------------------------------------------- |
| 1.0        | 2026-02-01 | 初版作成（認証ミドルウェア実装完了）         |
| 2.0        | 2026-02-01 | CORS・エラーハンドリング統合、Phase 番号削除 |
