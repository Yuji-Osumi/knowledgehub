# 認証ミドルウェア・保護実装 詳細設計書

**バージョン:** 1.0
**作成日:** 2026-02-01
**最終更新日:** 2026-02-01
**ステータス:** 実装完了（MVP）

---

## 目次

1. [概要](#概要)
2. [エンドポイント認証定義](#エンドポイント認証定義)
3. [実装詳細](#実装詳細)
4. [セキュリティ設計](#セキュリティ設計)
5. [実装コード例](#実装コード例)
6. [検討事項と設計選択](#検討事項と設計選択)
7. [テスト方針](#テスト方針)
8. [将来の拡張性](#将来の拡張性)
9. [参考資料](#参考資料)

---

## 概要

### 実装目的

MVP フェーズにおいて、KnowledgeHub のすべてのプライベートエンドポイントに認証ミドルウェアを実装し、以下を実現する：

- **セッション+Cookie 認証** による安全かつシンプルな認証
- **所有者チェック** による個人データの保護
- **論理削除対応** による削除リソースの隠蔽
- **エラーレスポンス統一** による情報漏洩防止

### 実装済み機能一覧

| 機能                               | ファイル                            | ステータス |
| ---------------------------------- | ----------------------------------- | ---------- |
| セッション管理（Redis）            | `backend/app/core/redis_manager.py` | ✅ 完了     |
| 認証依存関数（`get_current_user`） | `backend/app/core/dependencies.py`  | ✅ 完了     |
| パスワードセキュリティ             | `backend/app/core/security.py`      | ✅ 完了     |
| ログイン API                       | `backend/app/api/auth.py`           | ✅ 完了     |
| サインアップ API                   | `backend/app/api/auth.py`           | ✅ 完了     |
| ログアウト API                     | `backend/app/api/auth.py`           | ✅ 完了     |
| GET /auth/me（ユーザー情報取得）   | `backend/app/api/auth.py`           | ✅ 完了     |
| Articles API（CRUD + 認証）        | `backend/app/api/articles.py`       | ✅ 完了     |
| 所有者チェック実装                 | `backend/app/api/articles.py`       | ✅ 完了     |
| 論理削除フィルタ                   | `backend/app/api/articles.py`       | ✅ 完了     |
| 例外処理・エラーレスポンス         | `backend/app/core/exceptions.py`    | ✅ 完了     |

---

## エンドポイント認証定義

### 認証不要 API（Public Endpoints）

下記のエンドポイントは認証なしでアクセス可能です。

| メソッド | エンドポイント | 説明           | 認証   | ステータスコード |
| -------- | -------------- | -------------- | ------ | ---------------- |
| POST     | `/auth/signup` | ユーザー登録   | ❌ 不要 | 201 Created      |
| POST     | `/auth/login`  | ログイン       | ❌ 不要 | 200 OK           |
| GET      | `/health`      | ヘルスチェック | ❌ 不要 | 200 OK           |

### 認証必須 API（Private Endpoints）

下記のエンドポイントは認証（Cookie の `session_id`）が必須です。

| メソッド | エンドポイント          | 説明                   | 認証   | 所有者チェック         |
| -------- | ----------------------- | ---------------------- | ------ | ---------------------- |
| POST     | `/auth/logout`          | ログアウト             | ✅ 必須 | -                      |
| GET      | `/auth/me`              | 現在のユーザー情報取得 | ✅ 必須 | -                      |
| GET      | `/articles`             | 記事一覧取得           | ✅ 必須 | 不要（自分の記事のみ） |
| POST     | `/articles`             | 記事作成               | ✅ 必須 | -                      |
| GET      | `/articles/{public_id}` | 記事詳細取得           | ✅ 必須 | 必須（404 で統一）     |
| PUT      | `/articles/{public_id}` | 記事更新               | ✅ 必須 | 必須（404 で統一）     |
| DELETE   | `/articles/{public_id}` | 記事削除（論理削除）   | ✅ 必須 | 必須（404 で統一）     |

### 今後実装予定（Phase 2）

- `GET /tags` / `POST /tags` / `PUT /tags/{id}` / `DELETE /tags/{id}`
- `GET /folders` / `POST /folders` / `PUT /folders/{id}` / `DELETE /folders/{id}`
- `GET /logs`（監査ログ取得・管理者権限必須）

---

## 実装詳細

### 1. `get_current_user()` 依存関数の仕様

**ファイル:** `backend/app/core/dependencies.py`

**目的：** FastAPI の依存性注入システムを利用して、認証を必須とするエンドポイントで自動的にユーザー検証を行う。

#### 処理フロー

```
1. Request オブジェクトから Cookie を抽出
2. session_id の有無確認 → 無い場合は 401 Unauthorized
3. Redis でセッション有効性確認
   - セッション未検出 → 401 Unauthorized
   - 期限切れ → 401 Unauthorized
   - 有効 → 次へ
4. セッションから user_id（UUID）を取得
5. DB クエリで User オブジェクトを取得
   - ユーザー未検出 → 401 Unauthorized
   - 取得成功 → User オブジェクトを返却
```

#### エラーレスポンス

全ての認証エラーは統一的に以下を返却：

```json
{
  "detail": "Unauthorized"
}
```

**ステータスコード:** `401 Unauthorized`

### 2. Cookie セッション検証フロー

#### Cookie 設定の詳細

| 項目     | 値                    | 目的                                            |
| -------- | --------------------- | ----------------------------------------------- |
| key      | session_id            | セッション識別子                                |
| value    | UUID v4 hex（32文字） | セッション ID                                   |
| httponly | true                  | XSS（JavaScript 経由のアクセス）を防止          |
| secure   | 本番環境のみ true     | HTTPS 通信時のみ送信                            |
| samesite | lax                   | CSRF 攻撃を軽減（外部サイトからの POST は除外） |
| max_age  | 86400                 | 24時間有効                                      |
| path     | /                     | 全経路で有効                                    |

---

## セキュリティ設計

### 1. 所有者チェックロジック（404 で統一）

#### 実装パターン

記事の更新・削除時に、認証ユーザーの user_id がリソースの user_id と一致するか確認。
**不一致の場合は 404 Not Found を返却する（403 Forbidden ではない）。**

```python
def update_article(
    public_id: UUID,
    payload: ArticleUpdate,
    user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    # 1. リソース検索（is_valid=True のみ）
    article = db.query(Article).filter(
        Article.public_id == public_id,
        Article.is_valid == True,
    ).first()

    if not article:
        raise NotFoundError(f"Article with public_id {public_id} not found")

    # 2. 所有者チェック（不一致でも 404 を返す）
    if article.user_id != user.id:
        raise NotFoundError(f"Article with public_id {public_id} not found")

    # 3. 更新処理
    article.title = payload.title
    article.content = payload.content
    article.updated_by = user.id
    db.add(article)
    db.commit()
    db.refresh(article)

    return article
```

#### 404 で統一する理由

| 理由               | 説明                                                                                                                         |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------------- |
| **情報漏洩防止**   | 403 Forbidden では「リソースは存在するが、アクセス権がない」と判明。404 により、リソースそのものが存在しないかのように見せる |
| **一貫性**         | 削除済みリソース（is_valid=False）へのアクセスも 404 で返すため、ユーザーからはリソースの存在状況が判別不可                  |
| **ユーザビリティ** | クライアント側の処理が単純化                                                                                                 |

### 2. 論理削除対応（is_valid フィルタ）

全ての SELECT クエリに **`is_valid == True` 条件** を付与：

```python
# ✅ 正しい実装（is_valid=True フィルタ）
articles = db.query(Article).filter(
    Article.user_id == user.id,
    Article.is_valid == True,
).all()

# ❌ 誤った実装（フィルタなし）
articles = db.query(Article).filter(
    Article.user_id == user.id,
).all()
```

### 3. エラーレスポンス戦略

#### ステータスコード使い分け

| ステータス                | 用途                         | 例                                |
| ------------------------- | ---------------------------- | --------------------------------- |
| 200 OK                    | 成功                         | ログイン成功、記事取得成功        |
| 201 Created               | リソース作成成功             | 記事作成、ユーザー登録            |
| 204 No Content            | 成功（レスポンスボディなし） | ログアウト、記事削除              |
| 422 Unprocessable Entity  | バリデーションエラー         | パスワード強度不足                |
| 401 Unauthorized          | 認証失敗                     | Cookie 未設定、セッション期限切れ |
| 404 Not Found             | リソース未検出または権限不足 | 記事未検出、所有者不一致          |
| 500 Internal Server Error | サーバーエラー               | DB 接続失敗                       |

---

## 実装コード例

### 認証ミドルウェア使用例

```python
from fastapi import APIRouter, Depends, status
from app.core.dependencies import get_current_user
from app.db.models.user import User

router = APIRouter()

@router.get("/me")
async def get_me(
    user: User = Depends(get_current_user),  # ← 認証必須
):
    """認証が必須なエンドポイント"""
    return {
        "public_id": str(user.public_id),
        "email": user.email,
        "display_name": user.display_name,
    }
```

### 所有者チェック実装

```python
def get_article_by_id(
    public_id: UUID,
    user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """記事詳細取得"""
    article = db.query(Article).filter(
        Article.public_id == public_id,
        Article.user_id == user.id,  # ← 所有者チェック
        Article.is_valid == True,
    ).first()

    if not article:
        raise NotFoundError(f"Article with public_id {public_id} not found")

    return article
```

---

## 検討事項と設計選択

### 1. JWT vs Session 認証

**選択: Session + Cookie（MVP 採用）**

| 項目                 | Session  | JWT  | 採用理由                            |
| -------------------- | -------- | ---- | ----------------------------------- |
| **実装複雑度**       | シンプル | 複雑 | ✅ Session：MVP ではシンプルさを優先 |
| **セッション無効化** | 即座     | 困難 | ✅ Session：セキュリティ対応が重要   |
| **モバイル対応**     | 困難     | 対応 | JWT が有利。Phase 2 で検討          |

**Phase 2 での検討：** モバイルアプリケーション化が必要な場合は JWT への移行を推奨。

### 2. Public/Private エンドポイント設計

| 判断基準                   | 判定    | 例                        |
| -------------------------- | ------- | ------------------------- |
| **ユーザー個人データ**     | Private | 記事、タグ、フォルダ      |
| **ユーザー認証情報**       | Private | /auth/me, /auth/logout    |
| **ユーザー登録・ログイン** | Public  | /auth/signup, /auth/login |

### 3. 404 で所有者情報を隠す設計

**採用: 404 で統一**

**メリット：**
- ✅ リソース ID の枚挙攻撃への耐性向上
- ✅ 所有者関係の情報漏洩防止

### 4. 論理削除 vs 物理削除

| 方式         | 用途                                       |
| ------------ | ------------------------------------------ |
| **論理削除** | 個人データ・重要データ（記事、アカウント） |
| **物理削除** | ログ・一時データ（セッション）             |

---

## テスト方針

### 認証テストシナリオ

```python
def test_login_success():
    """正常なログイン"""
    response = client.post(
        "/auth/login",
        json={"email": "user@example.com", "password": "ValidPassword123"}
    )
    assert response.status_code == 200
    assert "session_id" in response.cookies

def test_get_other_user_article():
    """他のユーザーの記事は見えない"""
    # ユーザー B がユーザー A の記事にアクセス
    response = client.get(
        f"/articles/{article_id}",
        cookies=cookies_b
    )
    assert response.status_code == 404
```

---

## 将来の拡張性

### Phase 2 での検討事項

#### 1. JWT への移行

**タイミング:** モバイルアプリケーション対応時

**実装ステップ:**
1. JWT 署名・検証ロジック実装
2. Token Refresh エンドポイント追加
3. Cookie と Authorization ヘッダの両対応

#### 2. API キー方式

**用途:** 外部サービス連携、Webhook 認証

#### 3. ロールベースアクセス制御（RBAC）

- ユーザー権限管理（admin / user）
- リソースレベルのアクセス制御

---

## 参考資料

### 関連ドキュメント

- 0.9.1_認証・認可方針：MVP 認証仕様・セッション管理
- 05_例外処理ポリシー（Backend）.md：エラーレスポンス定義
- 06_セキュリティ方針（MVP）.md：XSS、CSRF 対策

### 外部リソース

- [FastAPI 依存性注入](https://fastapi.tiangolo.com/tutorial/dependencies/)
- [OWASP 認証チートシート](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)

---

**文書版管理**

| バージョン | 日時       | 更新内容             |
| ---------- | ---------- | -------------------- |
| 1.0        | 2026-02-01 | 初版作成（実装完了） |
