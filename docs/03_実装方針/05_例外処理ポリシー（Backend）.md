# 例外処理ポリシー（Backend）

## 目的

本ドキュメントは、KnowledgeHub Backend における **API 例外処理とエラーレスポンスの統一方針**を定める。

実装時の迷いを減らし、
フロントエンドと安定して連携できることを目的とする。

---

## 基本方針

* FastAPI 標準の仕組みを優先する
* エラーは **隠さず・壊さず・一定の形で返す**
* ステータスコードと意味を一致させる

---

## エラーレスポンス形式（共通）

すべての API エラーは、以下の JSON 形式を基本とする。

```json
{
  "detail": "エラーメッセージ"
}
```

* `detail` は人が読める文字列
* 内部例外情報（stack trace 等）は含めない

---

## ステータスコード方針

### 400 Bad Request

* 入力値が不正
* バリデーションエラー

---

### 401 Unauthorized

* 未認証（ログインしていない）

---

### 403 Forbidden

* 認証済みだが権限がない

---

### 404 Not Found

* 対象リソースが存在しない

---

### 500 Internal Server Error

* 想定外の例外
* サーバー側の不具合

👉 クライアントには **一般的なメッセージのみ返す**

---

## FastAPI での実装方針

### 明示的なエラー

* `HTTPException` を使用する

```python
if note is None:
    raise HTTPException(status_code=404, detail="Note not found")
```

---

### バリデーションエラー

* Pydantic / FastAPI のデフォルト挙動を利用する
* 独自加工は行わない（MVP）

---

### 想定外例外

* 例外は握りつぶさない
* ログに出力する
* クライアントには 500 を返す

---

## フロントエンドとの連携

* フロントは `detail` を表示用メッセージとして扱う
* ステータスコードで分岐処理を行う

---

## 禁止事項

* 例外を `print` のみで処理する
* 異なる形式のエラーレスポンスを混在させる
* 内部エラー内容をそのまま返す

---

## 判断に迷った場合

* このエラーはクライアントの責任か
* ユーザーに何を伝えるべきか
* 実装を単純に保てているか

---

このポリシーは、
**Backend と Frontend を安全につなぐための最低限の約束事**である。
