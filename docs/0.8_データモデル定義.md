# 0.8 データモデル定義（ERD / テーブル一覧）

## 方針・前提

- DB：PostgreSQL
- ORM：SQLAlchemy
- ユーザーは原則1人（将来拡張を考慮）
- **実用性と安全性からidとpublic_idを併用する**
  - 内部IDはオートインクリメント（BIGSERIAL）とし、JOINやデバッグを容易にして開発効率を優先する
  - 外部公開IDにはUUID（public_id）を用い、URL上でのID推測を防ぎAPI設計の安全性を高める
  - 学習コストを抑えつつ、実務で一般的な設計パターンを経験できる構成とする
  - 将来的な拡張や外部公開を想定しても設計変更が最小で済む
- API・URLでは public_id を使用
- 検索は本アプリの価値の中核であり、全文検索（tsvector）を使用

---

## エンティティ一覧

- users
- articles
- tags
- article_tags
- folders
- article_versions
- operation_logs

---

## users

| カラム名      | 型        | 制約             | 説明                             |
| ------------- | --------- | ---------------- | -------------------------------- |
| id            | BIGSERIAL | PK               | 内部識別子                       |
| public_id     | UUID      | UNIQUE, NOT NULL | 外部公開用ID                     |
| email         | VARCHAR   | UNIQUE, NOT NULL | ログイン用メールアドレス         |
| password_hash | VARCHAR   | NOT NULL         | bcryptでハッシュ化したパスワード |
| created_at    | TIMESTAMP | NOT NULL         | 作成日時                         |
| updated_at    | TIMESTAMP | NOT NULL         | 更新日時                         |

---

## folders

| カラム名   | 型        | 制約                 | 説明                 |
| ---------- | --------- | -------------------- | -------------------- |
| id         | BIGSERIAL | PK                   | 内部識別子           |
| public_id  | UUID      | UNIQUE, NOT NULL     | 外部公開用ID         |
| user_id    | BIGINT    | FK(users.id)         | 所有ユーザー         |
| name       | VARCHAR   | NOT NULL             | フォルダ名           |
| parent_id  | BIGINT    | FK(folders.id), NULL | 親フォルダ（階層用） |
| created_at | TIMESTAMP | NOT NULL             | 作成日時             |
| updated_at | TIMESTAMP | NOT NULL             | 更新日時             |

---

## articles

| カラム名      | 型        | 制約                 | 説明         |
| ------------- | --------- | -------------------- | ------------ |
| id            | BIGSERIAL | PK                   | 内部識別子   |
| public_id     | UUID      | UNIQUE, NOT NULL     | 外部公開用ID |
| user_id       | BIGINT    | FK(users.id)         | 作成者       |
| folder_id     | BIGINT    | FK(folders.id), NULL | 所属フォルダ |
| title         | VARCHAR   | NOT NULL             | 記事タイトル |
| content       | TEXT      | NOT NULL             | Markdown本文 |
| search_vector | TSVECTOR  | INDEX                | 全文検索用   |
| created_at    | TIMESTAMP | NOT NULL             | 作成日時     |
| updated_at    | TIMESTAMP | NOT NULL             | 更新日時     |

**将来的にcontents_overviewの追加を検討**

**search_vector は title + content から生成**
- search_vector は検索処理を抽象化するためのカラムとして定義している
- 初期実装では PostgreSQL 標準の TSVECTOR（simple 辞書）を利用する
- 検索精度やランキング改善が必要になった場合は weight 調整やインデックス変更で対応可能
- 将来的に pgroonga や外部検索エンジンへ移行する場合も、API仕様を変更せずに差し替えられる設計としている

---

## tags

| カラム名   | 型        | 制約             | 説明         |
| ---------- | --------- | ---------------- | ------------ |
| id         | BIGSERIAL | PK               | 内部識別子   |
| public_id  | UUID      | UNIQUE, NOT NULL | 外部公開用ID |
| user_id    | BIGINT    | FK(users.id)     | 所有ユーザー |
| name       | VARCHAR   | UNIQUE, NOT NULL | タグ名       |
| created_at | TIMESTAMP | NOT NULL         | 作成日時     |
| updated_at | TIMESTAMP | NOT NULL         | 更新日時     |

---

## article_tags

| カラム名   | 型        | 制約                | 説明     |
| ---------- | --------- | ------------------- | -------- |
| id         | BIGSERIAL | PK, FK(articles.id) | 記事ID   |
| article_id | BIGINT    | PK, FK(articles.id) | 記事ID   |
| tag_id     | BIGINT    | PK, FK(tags.id)     | タグID   |
| created_at | TIMESTAMP | NOT NULL            | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL            | 更新日時 |

- 中間テーブル（多対多）

---

## article_versions（拡張）

| カラム名       | 型        | 制約            | 説明           |
| -------------- | --------- | --------------- | -------------- |
| id             | BIGSERIAL | PK              | 内部識別子     |
| article_id     | BIGINT    | FK(articles.id) | 対象記事       |
| version_number | INTEGER   | NOT NULL        | バージョン番号 |
| title          | VARCHAR   | NOT NULL        | 当時のタイトル |
| content        | TEXT      | NOT NULL        | 当時の本文     |
| created_at     | TIMESTAMP | NOT NULL        | 保存日時       |

- 記事保存時にスナップショットとして作成

---

## operation_logs（拡張）

| カラム名    | 型        | 制約         | 説明                                |
| ----------- | --------- | ------------ | ----------------------------------- |
| id          | BIGSERIAL | PK           | 内部識別子                          |
| user_id     | BIGINT    | FK(users.id) | 操作ユーザー                        |
| target_type | VARCHAR   | NOT NULL     | 対象種別（article, tag, folder 等） |
| target_id   | BIGINT    | NOT NULL     | 対象ID（内部ID）                    |
| action      | VARCHAR   | NOT NULL     | 操作内容（create, update, delete）  |
| created_at  | TIMESTAMP | NOT NULL     | 操作日時                            |

※ MVP では作成のみ、参照 API は後回し可

---

## ERD（テキスト表現）

- users 1 - N articles
- users 1 - N tags
- users 1 - N folders
- folders 1 - N articles
- articles N - N tags（article_tags）
(拡張オプション)
- articles 1 - N article_versions
- users 1 - N operation_logs

---

## 補足

- すべてのエンティティで public_id を API 露出用として使用
- 内部処理・JOIN は id（BIGSERIAL）を使用
- MVP段階ではパフォーマンスチューニングやパーティショニングは行わない

## 削減・割り切りポイント

- 論理削除（deleted_at）は採用しない
  - MVP段階では物理削除のみとし、実装・運用の複雑化を避ける
  - 削除データの復元や履歴管理は非スコープとする

- versions / operation_logs は拡張扱いとする
  - 初期実装では最低限の構造定義のみに留める
  - MVP完成を優先し、実装優先度は低めとする

- 権限管理・共有機能は非対応
  - ユーザーは原則1人とし、ロール・権限・共有概念は持たない
  - 将来的な拡張余地として設計上は排除しないが、現時点では考慮しない
