## 認証・認可方針

### 認証方式

- **Session + Cookie 認証を採用する**
- セッション ID をブラウザの HttpOnly Cookie に保存する
- 認証状態は Redis セッションストアで管理する（ステートフル）

本プロジェクトは MVP として個人利用を前提としており、**シンプルさとセキュリティを優先** する。
Session 方式により、トークン盗難時の即座の無効化と直感的なログアウト制御を実現する。
将来モバイル化の需要が明確になった場合は、その時点で JWT への移行を検討する。

---

### セッション仕様

#### **セッションID（MVP）**

- **有効期限**: 24 時間
- **生成方法**: UUID v4（`uuid.uuid4().hex`）
- **ストレージ**: Redis（key: `session:{session_id}`）
- **値の構造**:
  ```json
  {
    "user_id": "uuid-string",
    "exp_timestamp": 1234567890
  }
  ```
- **保存場所**: HttpOnly Cookie（`session_id`）
- **自動削除**: Redis TTL 24 時間で自動削除

---

### Cookie 設定

- **HttpOnly**: 有効
  - JavaScriptからのCookieアクセスを禁止し、XSSによるトークン盗難を防止する
- **SameSite**: Lax
  - 外部サイトからの不正なPOSTリクエストによるCSRF攻撃を抑止する
- **Secure**: 本番環境のみ有効
  - HTTPS通信時のみCookieを送信する
- **Max-Age**: 86400 秒（24時間）

CSRFトークンは実装せず、SameSite=Lax による最低限のCSRF対策を行う。

---

### セッション無効化戦略

- **直接削除による即座の無効化**
- ログアウト時に Redis から `session:{session_id}` を削除
- Cookie も同時に削除（Max-Age=0）
- ブラウザが閉じられた場合は Cookie が削除され、再ログインが必須

**Redis キー構造：**
```
session:{session_id} → {user_id, exp_timestamp} (TTL: 86400秒)
```

---

### 認証フロー

#### **ログイン**
```
1. POST /auth/login（email + password）
2. パスワード検証（bcrypt）
3. セッション ID 生成（UUID v4）
4. Redis に session データ保存（TTL 24h）
5. Cookie に session_id を設定（HttpOnly, Secure, SameSite=Lax）
6. 200 OK 返却
```

#### **API アクセス**
```
1. リクエスト受信
2. Cookie から session_id 取得
3. Redis から session データ取得
4. user_id・有効期限確認
5. user_id を取得して処理実行
```

#### **ログアウト**
```
1. POST /auth/logout
2. Cookie から session_id 取得
3. Redis から session:{session_id} 削除
4. Cookie 削除（Max-Age=0）
5. 200 OK 返却
```

---

### 認証対象API

以下のAPIは認証必須とする。

- POST /auth/logout
- GET /auth/me
- articles / tags / folders / logs に関する全API

未認証状態でアクセスされた場合は `401 Unauthorized` を返却する。

---

### 認証不要API

以下のAPIは認証不要とする。

- POST /auth/login

---

### セッション検証フロー

#### **リクエスト時の検証**
```python
1. Cookie から session_id を抽出
2. Redis から session:{session_id} を取得
3. exp_timestamp が現在時刻より後か確認
4. 有効 → user_id を取得して処理継続
5. 期限切れ・未検出 → 401 Unauthorized を返却
```

---

### セキュリティに関する割り切り

- 多端末ログイン管理は行わない
- トークンの同時ログイン制限は行わない
- ログイン試行回数制限やCAPTCHAは実装しない
- リフレッシュトークンは Phase 2 以降に実装（MVP は 24h 固定）

これらは公開サービスや多ユーザー環境では必要となるが、
本プロジェクトでは個人利用・限定公開を前提としているため非対応とする。

---

### 強制ログアウト（セキュリティインシデント時）

#### **MVP**
- 手動対応（Redis CLI で個別 session_id を削除）
- 個人用途なので頻度は極低
- コマンド例：`DEL session:abc123def456...`

#### **Phase 2**
- 管理 API 実装（`POST /admin/force-logout/{user_id}`）
- ユーザーの全アクティブセッションを一括削除

---

### ユーザー識別について

- API上では users.public_id（UUID）をユーザー識別子として扱う
- 内部ID（BIGSERIAL）は外部に公開しない
- user_id はサーバー側でセッションから解決する
