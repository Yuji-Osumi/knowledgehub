## 認証・認可方針

### 認証方式

- **JWT（JSON Web Token）+ Cookie 認証を採用する**
- JWT をブラウザの HttpOnly Cookie に保存する
- 認証状態は JWT で管理する（ステートレス）

本プロジェクトは個人利用を前提としているが、将来的なモバイルアプリ対応や API 外部公開を見据え、
拡張性の高い JWT 認証を採用する。Cookie に保存することで XSS 対策と利便性を両立する。

---

### JWT トークン仕様

#### **アクセストークン（MVP）**

- **有効期限**: 24 時間
- **署名アルゴリズム**: HS256（HMAC-SHA256）
- **ペイロード構造**:
  ```json
  {
    "user_id": "uuid-string",
    "exp": 1234567890,
    "jti": "unique-token-id"
  }
  ```
- **保存場所**: HttpOnly Cookie（`access_token`）

#### **リフレッシュトークン（Phase 2 以降）**

- **有効期限**: 7 日間
- **実装時期**: Phase 2（自動ログイン UX 向上のため）
- **保存先**: Redis + HttpOnly Cookie

---

### Cookie 設定

- **HttpOnly**: 有効
  - JavaScriptからのCookieアクセスを禁止し、XSSによるトークン盗難を防止する
- **SameSite**: Lax
  - 外部サイトからの不正なPOSTリクエストによるCSRF攻撃を抑止する
- **Secure**: 本番環境のみ有効
  - HTTPS通信時のみCookieを送信する
- **Max-Age**: 86400 秒（24時間）

CSRFトークンは実装せず、SameSite=Lax による最低限のCSRF対策を行う。

---

### トークン無効化戦略（ブラックリスト）

- **Redis を使用したブラックリスト管理**
- ログアウト時に `blacklist:{jti}` キーを Redis に保存（TTL 24h）
- リクエスト検証時にブラックリスト確認
- 盗まれたトークンの強制無効化にも使用

**Redis キー構造：**
```
blacklist:{jti} → "true" (TTL: 86400秒)
```

---

### 認証フロー

#### **ログイン**
```
1. POST /auth/login（email + password）
2. パスワード検証（bcrypt）
3. JWT 生成（user_id, exp, jti を含む）
4. Cookie に JWT を設定（HttpOnly, Secure, SameSite=Lax）
5. 200 OK 返却
```

#### **API アクセス**
```
1. リクエスト受信
2. Cookie から JWT 取得
3. JWT 署名検証
4. ブラックリスト確認（Redis）
5. user_id を取得して処理実行
```

#### **ログアウト**
```
1. POST /auth/logout
2. JWT から jti 取得
3. Redis にブラックリスト追加
4. Cookie 削除
5. 200 OK 返却
```

---

### 認証対象API

以下のAPIは認証必須とする。

- POST /auth/logout
- GET /auth/me
- articles / tags / folders / logs に関する全API

未認証状態でアクセスされた場合は `401 Unauthorized` を返却する。

---

### 認証不要API

以下のAPIは認証不要とする。

- POST /auth/login

---

### JWT シークレットキー管理

#### **生成方法**
```bash
python -c "import secrets; print(secrets.token_urlsafe(64))"
```

#### **環境変数**
- `JWT_SECRET_KEY`: 署名・検証に使用（64文字以上推奨）
- `JWT_ALGORITHM`: 署名アルゴリズム（デフォルト: HS256）
- `JWT_ACCESS_TOKEN_EXPIRE_HOURS`: トークン有効期限（デフォルト: 24）

#### **環境分離**
- **開発環境**: `.env` ファイル（`.gitignore` で除外、`dev_` プレフィックス推奨）
- **本番環境**: Railway 環境変数（Git 保存禁止）

#### **ローテーション**
- **MVP**: 漏洩時のみ手動ローテーション（全ユーザーログアウト許容）
- **Phase 2**: グレースピリオド実装（24h 猶予、ユーザー影響最小化）

---

### セキュリティに関する割り切り

- 多端末ログイン管理は行わない
- トークンの同時ログイン制限は行わない
- ログイン試行回数制限やCAPTCHAは実装しない
- リフレッシュトークンは Phase 2 以降に実装（MVP は 24h 固定）

これらは公開サービスや多ユーザー環境では必要となるが、
本プロジェクトでは個人利用・限定公開を前提としているため非対応とする。

---

### 強制ログアウト（セキュリティインシデント時）

#### **MVP**
- 手動対応（Redis CLI で個別 jti をブラックリスト追加）
- 個人用途なので頻度は極低

#### **Phase 2**
- 管理 API 実装（`POST /admin/force-logout/{user_id}`）
- ユーザーの全アクティブトークンを一括無効化

---

### ユーザー識別について

- API上では users.public_id（UUID）をユーザー識別子として扱う
- 内部ID（BIGSERIAL）は外部に公開しない
- user_id はサーバー側で JWT から解決する
