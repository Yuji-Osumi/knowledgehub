# 0.9 API仕様定義（REST）

## 方針

* **認証方式：Session + Cookie 認証**
* APIはREST形式
* 外部公開ID（public_id: UUID）をURLパラメータとして使用
* レスポンスはJSON
* MVP優先・例外は最小限に定義

---

## 認証フロー詳細

### ログイン時の処理

```
1. クライアントが POST /auth/login を実行
2. バックエンドがパスワード検証（bcrypt）
3. セッション ID 生成（UUID v4）
4. Redis に session データ保存（TTL 24h）
5. Set-Cookie ヘッダーで session_id を返却
   - Cookie 名: session_id
   - HttpOnly: true
   - Secure: true（本番のみ）
   - SameSite: Lax
   - Max-Age: 86400（24時間）
6. クライアントはログイン成功レスポンスを受信
```

### API アクセス時の認証

```
1. クライアントが API リクエスト送信（Cookie 自動送信）
2. バックエンドが Cookie から session_id 取得
3. Redis から session:{session_id} を取得
4. 有効期限チェック（exp_timestamp）
5. user_id を抽出して API 処理実行
```

### ログアウト時の処理

```
1. クライアントが POST /auth/logout を実行
2. バックエンドが Cookie から session_id 取得
3. Redis から session:{session_id} 削除
4. Cookie 削除（Max-Age=0）
5. クライアントが 204 No Content を受信
```

### 将来の拡張パス（Phase 2）

- **モバイルアプリ対応**: Session から JWT への移行を検討
- **リフレッシュトークン**: その時点で実装
- **API 外部公開**: JWT ベースの API キー方式を採用

### 将来の拡張パス（Phase 2）

- **モバイルアプリ対応**: Authorization ヘッダーで Bearer トークン送信をサポート
- **リフレッシュトークン**: 1時間アクセストークン + 7日リフレッシュトークン
- **API 外部公開**: 同じ JWT 基盤で外部 API キー発行

---

## 認証（Auth）

### POST /auth/login

**概要**
メールアドレスとパスワードでログインし、JWT トークンを発行する。

**Request Body**

```json
{
  "email": "user@example.com",
  "password": "password"
}
```

**Response 200**
- Set-Cookie ヘッダ（HttpOnly, Secure, SameSite=Lax, Max-Age=86400）
  - Cookie 名: `session_id`
  - 値: UUID v4（32 文字 16 進数）
```json
{
  "id": "uuid",
  "email": "user@example.com"
}
```

**Error**

- 400: 入力不正
- 401: 認証失敗（メール or パスワード不正）

---

### GET /auth/me

**概要**
ログイン中のユーザー情報を取得する。

**Auth**

* 必須

**Response 200**

```json
{
  "id": "uuid",
  "email": "user@example.com"
}
```

**Error**

* 401: 未ログイン

---

### POST /auth/logout

**概要**
JWT トークンを無効化してログアウトする。

**Auth**

* 必須

**処理内容**
1. Cookie から session_id 取得
2. Redis から `session:{session_id}` を削除
3. Cookie 削除（Max-Age=0）

**Response 204**

**Error**

* 401: 未ログイン（JWT 不正・期限切れ）

---

## フロントエンド認証実装方針

### Cookie + JWT の取り扱い

#### **自動送信設定**
```javascript
// axios の設定（src/main.tsx または API クライアント初期化）
import axios from 'axios';

axios.defaults.withCredentials = true;

// 理由：
// - ブラウザが自動的に Cookie を送信
// - SET-COOKIE ヘッダーを受け取れるように設定
```

#### **CORS 設定（バックエンド側）**
```python
# backend/app/main.py
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],  # 開発環境（Vite デフォルト）
    allow_credentials=True,  # ❌ これがないと Cookie 送信されない（重要）
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**重要：** `allow_credentials=True` を設定しないと、Cookie が送信・受信されません

---

### ログイン・ログアウト実装パターン

#### **ログイン処理（フロントエンド）**
```typescript
// src/api/auth.ts
async function login(email: string, password: string) {
  const response = await axios.post('/auth/login', {
    email,
    password,
  });
  // Cookie は自動的にブラウザに保存される
  return response.data;
}
```

#### **API リクエスト（フロントエンド）**
```typescript
// Cookie が自動的に送信される
const response = await axios.get('/api/articles');
// ブラウザが Cookie を自動付与 → バックエンドで JWT 検証
```

#### **ログアウト処理（フロントエンド）**
```typescript
// src/api/auth.ts
async function logout() {
  await axios.post('/auth/logout');
  // Cookie は自動的に削除される（バックエンド側で Max-Age=0 を設定）

  // ユーザーをログイン画面へリダイレクト
  window.location.href = '/login';
}
```

#### **401 エラーハンドリング**
```typescript
// axios インターセプター
// MVP では単純にログイン画面へリダイレクト
// Phase 2 でリフレッシュトークン自動更新を追加

axios.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      // JWT 期限切れ or ブラックリスト済み or トークン無効
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

---

### 認証エラーレスポンス仕様

#### **400 Bad Request（入力不正）**
```json
{
  "detail": "Email and password are required"
}
```

#### **401 Unauthorized（認証失敗）**
```json
{
  "detail": "Invalid email or password"
}
```

#### **401 Unauthorized（トークン無効）**
```json
{
  "detail": "Invalid or expired token"
}
```

#### **401 Unauthorized（ブラックリスト済み）**
```json
{
  "detail": "Token has been revoked"
}
```

---

### 開発環境での注意事項

#### **localhost でのテスト**
```
CORS Origin: http://localhost:5173 （Vite フロント）
API URL: http://localhost:8000 （FastAPI バック）
Cookie Domain: localhost
Cookie Secure: false （HTTP のため）
```

**重要注意：** `http://127.0.0.1:8000` と `http://localhost:8000` は異なるドメインとして扱われ、Cookie が共有されません

#### **本番環境での CORS 設定**
```python
# Railway デプロイ時
allow_origins=["https://yourdomain.com"]
allow_credentials=True
```

---

### トラブルシューティング

#### **Cookie が送信されない**
- ✅ フロント：`axios.defaults.withCredentials = true` を設定しましたか？
- ✅ バック：CORS で `allow_credentials=True` を設定しましたか？
- ✅ localhost テスト：`http://localhost:*` で統一していますか？（127.0.0.1 NG）

#### **401 エラーが返ってくる**
- ✅ Cookie に JWT が保存されていますか？（ブラウザ DevTools → Applications → Cookies で確認）
- ✅ JWT が期限切れではありませんか？（ログインしてから 24h 以上経過）
- ✅ Redis にブラックリスト登録されていませんか？（ログアウト後の API アクセス）

#### **ブラウザで Cookie が見えない（HttpOnly）**
- HttpOnly Cookie はセキュリティのため、JavaScript から見えません（仕様です）
- DevTools の Network タブで Cookie ヘッダーを確認してください

---

## 記事（Articles）

### GET /articles

**概要**
記事一覧を取得する。

**Query Params**

* folder_id（optional, UUID）
* tag_id（optional, UUID）

**Auth**

* 必須

**Response 200**

```json
[
  {
    "id": "uuid",
    "title": "Sample",
    "updated_at": "2025-01-01T00:00:00"
  }
]
```

---

### POST /articles

**概要**
記事を新規作成する。

**Request Body**

```json
{
  "title": "Title",
  "content": "Markdown text",
  "folder_id": "uuid"
}
```

**Response 201**

```json
{
  "id": "uuid"
}
```

---

### GET /articles/{id}

**概要**
記事詳細を取得する。

**Path Param**

* id: 記事public_id

**Auth**

* 必須

**Response 200**

```json
{
  "id": "uuid",
  "title": "Title",
  "content": "Markdown text",
  "tags": ["tag1", "tag2"]
}
```

---

### PUT /articles/{id}

**概要**
記事を更新する（更新時にversionを作成）。

**Request Body**

```json
{
  "title": "Updated",
  "content": "Updated content",
  "folder_id": "uuid"
}
```

**Response 200**

```json
{
  "id": "uuid"
}
```

---

### DELETE /articles/{id}

**概要**
記事を削除する（物理削除）。

**Response 204**

---

## 検索（Search）

### GET /search

**概要**
全文検索を行う。

**Query Params**

* q: 検索クエリ

**Response 200**

```json
[
  {
    "id": "uuid",
    "title": "Matched title"
  }
]
```

---

## タグ（Tags）

### GET /tags

### POST /tags

### DELETE /tags/{id}

---

## フォルダ（Folders）

### GET /folders

### POST /folders

### PUT /folders/{id}

### DELETE /folders/{id}

---

## バージョン（Article Versions）※拡張

### GET /articles/{id}/versions

---

## 操作ログ（Operation Logs）※拡張

### GET /logs
