# 0.8 データモデル定義（ERD / テーブル一覧）

## 方針・前提

- DB：PostgreSQL
- ORM：SQLAlchemy
- ユーザーは原則1人（将来拡張を考慮）
- **実用性と安全性からidとpublic_idを併用する**
  - 内部IDはオートインクリメント（SERIAL）とし、JOINやデバッグを容易にして開発効率を優先する
  - 外部公開IDにはUUID（public_id）を用い、URL上でのID推測を防ぎAPI設計の安全性を高める
  - 学習コストを抑えつつ、実務で一般的な設計パターンを経験できる構成とする
  - 将来的な拡張や外部公開を想定しても設計変更が最小で済む
- API・URLでは public_id を使用
- **検索は本アプリの価値の中核**
  - MVP: LIKE検索 → フェーズ2: pg_bigm で高速化 → v2: Embeddings で意味検索
  - PostgreSQL標準のTSVECTOR（simple辞書）は日本語非対応のため不採用

---

## エンティティ一覧

- users
- articles
- tags
- article_tag_links
- folders
- article_versions
- operation_logs

---

## 共通カラム（横断定義）

多くのテーブルで横断的に利用する共通カラムを以下に定義します。API・URLでは `public_id` を用い、内部処理やJOINでは `id` を用いる方針です。

| カラム名   | 型          | 制約             | 説明                          |
| ---------- | ----------- | ---------------- | ----------------------------- |
| id         | SERIAL      | PK               | 内部識別子（JOIN/デバッグ用） |
| public_id  | UUID        | UNIQUE, NOT NULL | 外部公開用ID（API/URL用）     |
| is_valid   | BOOLEAN     | NOT NULL         | 削除フラグ/利用可否           |
| created_by | INTEGER     | NOT NULL         | 作成ユーザーID                |
| created_at | TIMESTAMPTZ | NOT NULL         | 作成日時                      |
| updated_by | INTEGER     | NOT NULL         | 更新ユーザーID                |
| updated_at | TIMESTAMPTZ | NOT NULL         | 更新日時                      |

- 原則として users / folders / articles / tags は `public_id` を持つ主要エンティティです。
- 中間テーブル（article_tag_links）や履歴（article_versions）、ログ（operation_logs）は `public_id` を持たない設計です。

---

## users　（ユーザー）

| カラム名      | 型           | 制約             | 説明                             |
| ------------- | ------------ | ---------------- | -------------------------------- |
| id            | SERIAL       | PK               | 内部識別子                       |
| public_id     | UUID         | UNIQUE, NOT NULL | 外部公開用ID                     |
| email         | VARCHAR(255) | UNIQUE, NOT NULL | ログイン用メールアドレス         |
| password_hash | VARCHAR(255) | NOT NULL         | bcryptでハッシュ化したパスワード |
| display_name  | VARCHAR(100) | NOT NULL         | UI表示用ユーザー名               |
| is_valid      | BOOLEAN      | NOT NULL         | 論理削除・利用可否フラグ         |
| created_by    | INTEGER      | NOT NULL         | 作成ユーザーID                   |
| created_at    | TIMESTAMPTZ  | NOT NULL         | レコード作成日時                 |
| updated_by    | INTEGER      | NOT NULL         | 更新ユーザーID                   |
| updated_at    | TIMESTAMPTZ  | NOT NULL         | レコード更新日時                 |

---

## folders　（フォルダ）

| カラム名   | 型           | 制約                 | 説明                 |
| ---------- | ------------ | -------------------- | -------------------- |
| id         | SERIAL       | PK                   | 内部識別子           |
| public_id  | UUID         | UNIQUE, NOT NULL     | 外部公開用ID         |
| user_id    | INTEGER      | FK(users.id)         | 所有ユーザー         |
| name       | VARCHAR(100) | NOT NULL             | フォルダ名           |
| parent_id  | INTEGER      | FK(folders.id), NULL | 親フォルダ（階層用） |
| is_valid   | BOOLEAN      | NOT NULL             | 削除フラグ           |
| created_by | INTEGER      | NOT NULL             | 作成ユーザーID       |
| created_at | TIMESTAMPTZ  | NOT NULL             | 作成日時             |
| updated_by | INTEGER      | NOT NULL             | 更新ユーザーID       |
| updated_at | TIMESTAMPTZ  | NOT NULL             | 更新日時             |

---

## articles　（記事）

| カラム名          | 型           | 制約                     | 説明                         |
| ----------------- | ------------ | ------------------------ | ---------------------------- |
| id                | SERIAL       | PK                       | 内部識別子                   |
| public_id         | UUID         | UNIQUE, NOT NULL         | 外部公開用ID                 |
| user_id           | INTEGER      | FK(users.id)             | 作成者                       |
| folder_id         | INTEGER      | FK(folders.id), NULL可能 | 所属フォルダ                 |
| title             | VARCHAR(255) | NOT NULL                 | 記事タイトル                 |
| content           | TEXT         | NOT NULL                 | Markdown本文                 |
| content_embedding | VECTOR(768)  | NULL可能                 | AI検索用ベクトル（将来実装） |
| is_valid          | BOOLEAN      | NOT NULL                 | 削除フラグ                   |
| created_by        | INTEGER      | NOT NULL                 | 作成ユーザーID               |
| created_at        | TIMESTAMPTZ  | NOT NULL                 | 作成日時                     |
| updated_by        | INTEGER      | NOT NULL                 | 更新ユーザーID               |
| updated_at        | TIMESTAMPTZ  | NOT NULL                 | 更新日時                     |

<!-- | is_published      | BOOLEAN      | NOT NULL                 | 公開／下書き状態                                       | -->
<!-- | published_at      | TIMESTAMPTZ  | NULL可能                 | 初回公開日時（is_published = true の場合のみ値を持つ） | -->

**将来的にcontents_overviewの追加を検討**

---

**全文検索実装戦略**

本アプリケーションの価値の中核である検索機能について、以下の段階的な実装方針を採用する。

- **MVP実装（フェーズ1）：キーワード検索**
  - LIKE検索による部分一致検索を実装
    - `WHERE title LIKE '%keyword%' OR content LIKE '%keyword%'`
  - 実装が最も簡単で、数百〜数千件規模では十分高速
  - 日本語・英語ともに確実に動作
  - PostgreSQL標準機能のみで実装可能

- **性能改善（フェーズ2）：pg_bigm による高速化**
  - PostgreSQL 拡張 `pg_bigm` を導入
  - `title` と `content` に GIN インデックスを作成
    ```sql
    CREATE EXTENSION pg_bigm;
    CREATE INDEX idx_articles_title_bigm ON articles USING gin (title gin_bigm_ops);
    CREATE INDEX idx_articles_content_bigm ON articles USING gin (content gin_bigm_ops);
    ```
  - 既存の LIKE クエリが自動的にインデックスを利用し高速化
  - 数万件規模でも 10-50ms 程度で検索可能
  - 日本語の部分一致検索が高速（文字 N-gram による検索）
  - Docker 環境なら導入が容易

- **拡張機能（v2以降）：AI による意味検索**
  - `embedding` カラム（VECTOR型）を活用
  - OpenAI Embeddings 等で記事を数値ベクトル化
  - pgvector 拡張によるコサイン類似度検索
    ```sql
    CREATE EXTENSION vector;
    CREATE INDEX idx_articles_embedding ON articles
      USING ivfflat (embedding vector_cosine_ops);
    ```
  - 意味的に類似した記事の検索・関連ノート自動提示
  - キーワード検索（pg_bigm）と意味検索（Embeddings）のハイブリッド検索
  - ランキング・スコアリング機能の実装
  - RAG（Retrieval-Augmented Generation）への拡張

**検索方針の理由**
- キーワード検索は pg_bigm で十分高速かつ実用的
- AI による意味検索は Embeddings（VECTOR型）で実装
- 従来の TSVECTOR（PostgreSQL全文検索）は以下の理由で不採用：
  - simple 辞書では日本語の単語分割ができない（完全一致のみ）
  - pg_bigm の方が日本語部分一致検索で高性能
  - 将来の Embeddings 実装時に TSVECTOR は不要
  - 二重実装（TSVECTOR + Embeddings）を避けシンプルに保つ

---

## tags (タグ)

| カラム名   | 型           | 制約             | 説明           |
| ---------- | ------------ | ---------------- | -------------- |
| id         | SERIAL       | PK               | 内部識別子     |
| public_id  | UUID         | UNIQUE, NOT NULL | 外部公開用ID   |
| user_id    | INTEGER      | FK(users.id)     | 所有ユーザー   |
| name       | VARCHAR(100) | NOT NULL         | タグ名         |
| is_valid   | BOOLEAN      | NOT NULL         | 削除フラグ     |
| created_by | INTEGER      | NOT NULL         | 作成ユーザーID |
| created_at | TIMESTAMPTZ  | NOT NULL         | 作成日時       |
| updated_by | INTEGER      | NOT NULL         | 更新ユーザーID |
| updated_at | TIMESTAMPTZ  | NOT NULL         | 更新日時       |

- UNIQUE (user_id, name)

---

## article_tag_links (記事―タグ中間)

| カラム名   | 型          | 制約                      | 説明           |
| ---------- | ----------- | ------------------------- | -------------- |
| id         | SERIAL      | PK                        | 内部識別子     |
| article_id | INTEGER     | NOT NULL, FK(articles.id) | 記事ID         |
| tag_id     | INTEGER     | NOT NULL, FK(tags.id)     | タグID         |
| is_valid   | BOOLEAN     | NOT NULL                  | 削除フラグ     |
| created_by | INTEGER     | NOT NULL                  | 作成ユーザーID |
| created_at | TIMESTAMPTZ | NOT NULL                  | 作成日時       |
| updated_by | INTEGER     | NOT NULL                  | 更新ユーザーID |
| updated_at | TIMESTAMPTZ | NOT NULL                  | 更新日時       |

- UNIQUE (article_id, tag_id)
- 中間テーブル（多対多）

---

## article_versions（拡張）

| カラム名       | 型          | 制約            | 説明           |
| -------------- | ----------- | --------------- | -------------- |
| id             | SERIAL      | PK              | 内部識別子     |
| article_id     | BIGINT      | FK(articles.id) | 対象記事       |
| version_number | INTEGER     | NOT NULL        | バージョン番号 |
| title          | VARCHAR     | NOT NULL        | 当時のタイトル |
| content        | TEXT        | NOT NULL        | 当時の本文     |
| is_valid       | BOOLEAN     | NOT NULL        | 削除フラグ     |
| created_by     | INTEGER     | NOT NULL        | 作成ユーザーID |
| created_at     | TIMESTAMPTZ | NOT NULL        | 保存日時       |
| updated_by     | INTEGER     | NOT NULL        | 更新ユーザーID |
| updated_at     | TIMESTAMPTZ | NOT NULL        | 更新日時       |

- 記事保存時にスナップショットとして作成

---

## operation_logs（拡張）

| カラム名    | 型          | 制約         | 説明                                |
| ----------- | ----------- | ------------ | ----------------------------------- |
| id          | SERIAL      | PK           | 内部識別子                          |
| user_id     | INTEGER     | FK(users.id) | 操作ユーザー                        |
| target_type | VARCHAR     | NOT NULL     | 対象種別（article, tag, folder 等） |
| target_id   | INTEGER     | NOT NULL     | 対象ID（内部ID）                    |
| action      | VARCHAR     | NOT NULL     | 操作内容（create, update, delete）  |
| is_valid    | BOOLEAN     | NOT NULL     | 削除フラグ                          |
| created_by  | INTEGER     | NOT NULL     | 作成ユーザーID                      |
| created_at  | TIMESTAMPTZ | NOT NULL     | 操作日時                            |
| updated_by  | INTEGER     | NOT NULL     | 更新ユーザーID                      |
| updated_at  | TIMESTAMPTZ | NOT NULL     | 更新日時                            |

※ MVP では作成のみ、参照 API は後回し可

---

## ERD（テキスト表現）

- users 1 - N articles
- users 1 - N tags
- users 1 - N folders
- folders 1 - N articles
- articles N - N tags（article_tags）
(拡張オプション)
- articles 1 - N article_versions
- users 1 - N operation_logs

---

## Redis データ設計

JWT 認証における Redis の役割と構造を定義する。

### JWT ブラックリスト

**用途**: ログアウト時のトークン無効化

**キー構造**:
```
blacklist:{jti} → "true"
```

**TTL**: 86400 秒（24 時間、JWT 有効期限と同じ）

**例**:
```redis
SET blacklist:550e8400-e29b-41d4-a716-446655440000 "true" EX 86400
```

**検証ロジック**:
```python
if redis.get(f"blacklist:{jti}"):
    raise 401  # トークン無効
```

### Phase 2 以降：リフレッシュトークン管理

**用途**: リフレッシュトークンの有効性管理

**キー構造**:
```
refresh:{jti} → user_public_id
```

**TTL**: 604800 秒（7 日間）

**例**:
```redis
SET refresh:650e8400-e29b-41d4-a716-446655440001 "550e8400-e29b-41d4-a716-446655440000" EX 604800
```

### セッションテーブルは不要

JWT + Redis ブラックリスト方式を採用するため、PostgreSQL にセッションテーブルを作成しない。
ステートレス設計を維持しつつ、必要最小限の状態管理を Redis で行う。

---

## 補足

- すべてのエンティティで public_id を API 露出用として使用
- 内部処理・JOIN は id（BIGSERIAL）を使用
- MVP段階ではパフォーマンスチューニングやパーティショニングは行わない

## 削減・割り切りポイント

- **論理削除（is_valid）を全エンティティに採用**
  - MVP段階では物理削除ではなく、`is_valid = false` による soft-delete を実装
  - 誤削除の復旧、削除履歴の監査が可能になる実務的な利点を優先
  - クエリ側では `WHERE is_valid = true` をデフォルトフィルタとして適用
  - 削除データの復元・完全消去 API は非スコープとし、将来実装

- versions / operation_logs は拡張扱いとする
  - 初期実装では最低限の構造定義のみに留める
  - MVP完成を優先し、実装優先度は低めとする

- 権限管理・共有機能は非対応
  - ユーザーは原則1人とし、ロール・権限・共有概念は持たない
  - 将来的な拡張余地として設計上は排除しないが、現時点では考慮しない
